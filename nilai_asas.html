<script>
const SHEET_ID = "17GeYfdyiD8IrTePPPu0maRl8V3MKk4zJ";

/* ========== FUNGSI PROPER CASE ========== */
function toProper(text) {
  if (!text) return "";
  return text
    .toLowerCase()
    .split(" ")
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

// Show password toggle
document.getElementById("showPassword").addEventListener("change", function () {
  const p = document.getElementById("password");
  p.type = this.checked ? "text" : "password";
});

async function login() {
  const nisn = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();
  const kelas = document.getElementById("kelas").value;

  if (pass !== "asas2025") {
    document.getElementById("loginError").innerText = "Password salah!";
    return;
  }

  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${kelas}&tqx=out:json`;

  try {
    const res = await fetch(url);
    const raw = await res.text();
    const json = JSON.parse(raw.substring(47, raw.length - 2));

    const rows = json.table.rows.map(r => r.c.map(c => (c ? c.v : "")));
    const siswa = rows.find(r => String(r[0]) === nisn);

    if (!siswa) {
      document.getElementById("loginError").innerText =
        "NISN tidak ditemukan di kelas " + kelas;
      return;
    }

    // ================== SWITCH TO DASHBOARD ==================
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("dashboardBox").style.display = "block";

    // ================== OUTPUT DENGAN FORMAT PROPER ==================

    // Nama jadi Proper
    document.getElementById("nama").innerText = toProper(siswa[1]);

    // Kelas tetap kapital (sesuai tampilan sebelumnya)
    document.getElementById("kelasOut").innerText = siswa[2].toUpperCase();

    // Nilai + warna
    const nilai = Number(siswa[4]);
    const kkm = Number(siswa[5]);

    const nilaiEl = document.getElementById("nilai");
    nilaiEl.classList.remove("red", "green");
    nilaiEl.classList.add(nilai < kkm ? "red" : "green");
    nilaiEl.innerText = nilai;

    // Motivasi jadi Proper
    document.getElementById("motivasi").innerText = toProper(siswa[6]);

    // Remedi jadi Proper
    document.getElementById("remidi").innerText = toProper(siswa[8]);

  } catch (err) {
    document.getElementById("loginError").innerText =
      "Gagal memuat data! Pastikan Google Sheet sudah di-PUBLISH.";
  }
}

function logout() {
  document.getElementById("dashboardBox").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
}
</script>
